#
# Makefile.in
#
# Contact: JeCortex@yahoo.com
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#

srcdir = @srcdir@
top_srcdir = @top_srcdir@
top_builddir = @top_builddir@

SOURCES =\
	lbd.c \
	command.c \
	lbdcmdline.c \

TARGETS =\
	lbd

GENTARGETS =\
	command-count.h \
	cmds.h \
	command-lines-input.h 

DISTCLEAN_TARGETS += $(GENTARGETS)

include $(top_builddir)/make.build

lbd: $(OBJECTS) $(top_srcdir)/src/lib/liblbd-base.a $(top_srcdir)/src/libjraid/libjsraid.so
	$(Q) $(CC) $(CFLAGS) $(LDFLAGS) $(ELDFLAGS) -o $@ $^

command-count.h: $(srcdir)/command-lines.in
	@echo "    [GEN] $@"
	$(Q) set -o pipefail && \
	( cat $(top_srcdir)/src/tools/lbd/license.inc && \
	  echo "/* Do not edit. This file is generated by the Makefile. */" && \
	  echo -n "#define COMMAND_COUNT " && \
	  $(GREP) '^ID:' $(srcdir)/command-lines.in | $(WC) -l \
	) > $@

cmds.h: $(srcdir)/command-lines.in
	@echo "    [GEN] $@"
	$(Q) set -o pipefail && \
	( cat $(top_srcdir)/src/tools/lbd/license.inc && \
	  echo "/* Do not edit. This file is generated by the Makefile. */" && \
	  echo "cmd(CMD_NONE, none)" && \
	  $(GREP) '^ID:' $(srcdir)/command-lines.in | $(SORT) -u | $(AWK) '{print "cmd(" $$2 "_CMD, " $$2 ")"}' && \
	  echo "cmd(CMD_COUNT, count)" \
	) > $@

command-lines-input.h: $(srcdir)/command-lines.in
	@echo "    [GEN] $@"
	$(Q) set -o pipefail && \
	( cat $(top_srcdir)/src/tools/lbd/license.inc && \
	  echo "/* Do not edit. This file is generated by the Makefile. */" && \
	  echo -en "const char _command_input[] =\n\n\"" && \
	  $(EGREP) -v '^#|\-\-\-|^$$' $(srcdir)/command-lines.in | $(AWK) 'BEGIN {ORS = "\\n\"\n\""} //' && \
	  echo "\\n\";" \
	) > $@

jsraid: $(GENTARGETS) FORCE

.PHONY: FORCE jsraid $(GENTARGETS)
FORCE:
